{% extends 'mainmenu/base.html' %}
{% load static %}
{% load i18n %}
{% load custom_filters %}

{% block breadcrumbs %}
    <header class="mb-3">
        <a href="#" class="burger-btn d-block d-xl-none">
            <i class="bi bi-justify fs-3"></i>
        </a>
    </header>
    <div class="page-heading">
        <div class="page-title">
            <div class="row">
                <div class="col-12 col-md-6 order-md-1 order-last">
                    <h3>{% trans "Siparişler" %}</h3>
                </div>
                <div class="col-12 col-md-6 order-md-2 order-first">
                    <nav aria-label="breadcrumb" class="breadcrumb-header float-start float-lg-end">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="{% url 'users:dashboard' %}">{% trans "Dashboard" %}</a>
                            </li>
                            <li class="breadcrumb-item active" aria-current="page">{% trans "Siparişler" %}</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}
    <section class="section">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">{% trans "Sipariş Listesi" %}</h5>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#siparisModal"
                            onclick="openCreateModal()">
                        <i class="bi bi-plus-circle"></i> {% trans "Yeni Sipariş" %}
                    </button>
                </div>
            </div>
            <div class="card-body">
                <table class="table table-striped" id="table1">
                    <thead>
                    <tr>
                        <th>{% trans "Sipariş No" %}</th>
                        <th>{% trans "Müşteri" %}</th>
                        <th>{% trans "Ürün" %}</th>
                        <th>{% trans "Miktar" %}</th>
                        <th>{% trans "Fiyat" %}</th>
                        <th>{% trans "Toplam" %}</th>
                        <th>{% trans "Sipariş Tarihi" %}</th>
                        <th>{% trans "Üretici" %}</th>
                        <th>{% trans "Sevk Tarihi" %}</th>
                        <th>{% trans "Durum" %}</th>
                        <th>{% trans "İşlemler" %}</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for siparis in siparisler %}
                        <tr>
                            <td><strong>{{ siparis.siparis_no }}</strong></td>
                            <td>{{ siparis.musteri.ad }}</td>
                            <td>{{ siparis.get_urun_adi }}</td>
                            <td>{{ siparis.miktar }}</td>
                            <td>₺{{ siparis.fiyat|floatformat:2 }}</td>
                            <td><strong>₺{{ siparis.get_toplam_tutar|floatformat:2 }}</strong></td>
                            <td>{{ siparis.siparis_tarihi|date:"d.m.Y" }}</td>
                            <td>{{ siparis.uretici }}</td>
                            <td>{% if siparis.sevk_tarihi %}{{ siparis.sevk_tarihi|date:"d.m.Y" }}{% else %}
                                -{% endif %}</td>
                            <td>
                                <span class="badge bg-{{ siparis.durum|get_durum_class }}">
                                    {{ siparis.get_durum_display }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-info" onclick="openDetailModalById({{ siparis.id }})"
                                            title="{% trans 'Detay' %}">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="openEditModalById({{ siparis.id }})"
                                            title="{% trans 'Düzenle' %}">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger"
                                            onclick="openDeleteModal({{ siparis.id }}, '{{ siparis.siparis_no|escapejs }}')"
                                            title="{% trans 'Sil' %}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <div class="modal fade" id="siparisModal" tabindex="-1" aria-labelledby="siparisModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="siparisModalLabel">{% trans "Yeni Sipariş" %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="siparisForm" method="post">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="siparis_no" class="form-label">{% trans "Sipariş No" %}</label>
                                <input type="text" class="form-control" id="siparis_no" name="siparis_no" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="musteri" class="form-label">{% trans "Müşteri" %}</label>
                                <select class="form-select" id="musteri" name="musteri" required>
                                    <option value="">{% trans "Seçiniz" %}</option>
                                    {% for musteri in musteriler %}
                                        <option value="{{ musteri.id }}">{{ musteri.ad }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="urun" class="form-label">{% trans "Ürün Seçimi" %}</label>
                                <select class="form-select" id="urun" name="urun">
                                    <option value="">{% trans "Ürün Seçiniz (İsteğe Bağlı)" %}</option>
                                    {% for urun in urunler %}
                                        <option value="{{ urun.id }}" data-fiyat="{{ urun.fiyat }}">{{ urun.ad }} -
                                            ₺{{ urun.fiyat }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">{% trans "veya aşağıya manuel yazın" %}</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="urun_cinsi" class="form-label">{% trans "Ürün Cinsi (Manuel)" %}</label>
                                <input type="text" class="form-control" id="urun_cinsi" name="urun_cinsi">
                                <small class="text-muted">{% trans "Ürün seçilmediyse buraya yazın" %}</small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="miktar" class="form-label">{% trans "Miktar" %}</label>
                                <input type="number" class="form-control" id="miktar" name="miktar" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="fiyat" class="form-label">{% trans "Fiyat" %}</label>
                                <input type="number" step="0.01" class="form-control" id="fiyat" name="fiyat" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="uretici" class="form-label">{% trans "Üretici" %}</label>
                                <input type="text" class="form-control" id="uretici" name="uretici" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="siparis_tarihi" class="form-label">{% trans "Sipariş Tarihi" %}</label>
                                <input type="date" class="form-control" id="siparis_tarihi" name="siparis_tarihi"
                                       required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="sevk_tarihi" class="form-label">{% trans "Sevk Tarihi" %}</label>
                                <input type="date" class="form-control" id="sevk_tarihi" name="sevk_tarihi">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="durum" class="form-label">{% trans "Sipariş Durumu" %}</label>
                                <select class="form-select" id="durum" name="durum" required>
                                    <option value="onay_bekliyor">{% trans "Onay Bekliyor" %}</option>
                                    <option value="onaylandi">{% trans "Onaylandı" %}</option>
                                    <option value="malzeme_satin_alma">{% trans "Malzeme Satın Alma" %}</option>
                                    <option value="uretimde">{% trans "Üretimde" %}</option>
                                    <option value="print_tkac">{% trans "Baskı/Tkacılık" %}</option>
                                    <option value="boya">{% trans "Boya" %}</option>
                                    <option value="aksesuar_montaji">{% trans "Aksesuar Montajı" %}</option>
                                    <option value="kalite_kontrol">{% trans "Kalite Kontrol" %}</option>
                                    <option value="paketleme">{% trans "Paketleme" %}</option>
                                    <option value="uretiliyor">{% trans "Üretiliyor" %}</option>
                                    <option value="hazir">{% trans "Hazır, Sevkiyat Bekliyor" %}</option>
                                    <option value="sevkiyatta">{% trans "Sevkiyatta" %}</option>
                                    <option value="teslime_gonderildi">{% trans "Teslime Gönderildi" %}</option>
                                    <option value="teslim_edildi">{% trans "Teslim Edildi" %}</option>
                                    <option value="tamamlandi">{% trans "Tamamlandı" %}</option>
                                    <option value="iade_pererabotka">{% trans "İade/Perak" %}</option>
                                    <option value="iptal">{% trans "İptal" %}</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="not_bilgisi" class="form-label">{% trans "Not" %}</label>
                            <textarea class="form-control" id="not_bilgisi" name="not_bilgisi" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary"
                                data-bs-dismiss="modal">{% trans "İptal" %}</button>
                        <button type="submit" class="btn btn-primary">{% trans "Kaydet" %}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-gradient-primary text-white">
                    <h5 class="modal-title" id="detailModalLabel">
                        <i class="bi bi-file-text me-2"></i>{% trans "Sipariş Detayları" %}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="detail-item">
                                <label class="detail-label">{% trans "Sipariş No" %}</label>
                                <div class="detail-value" id="detail_siparis_no"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-item">
                                <label class="detail-label">{% trans "Müşteri" %}</label>
                                <div class="detail-value" id="detail_musteri"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-item">
                                <label class="detail-label">{% trans "Ürün" %}</label>
                                <div class="detail-value" id="detail_urun_cinsi"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-item">
                                <label class="detail-label">{% trans "Üretici" %}</label>
                                <div class="detail-value" id="detail_uretici"></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-item">
                                <label class="detail-label">{% trans "Miktar" %}</label>
                                <div class="detail-value text-primary" id="detail_miktar"></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-item">
                                <label class="detail-label">{% trans "Fiyat" %}</label>
                                <div class="detail-value text-success" id="detail_fiyat"></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-item">
                                <label class="detail-label">{% trans "Toplam" %}</label>
                                <div class="detail-value text-primary fw-bold" id="detail_toplam"></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-item">
                                <label class="detail-label">{% trans "Durum" %}</label>
                                <div id="detail_durum"></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-item">
                                <label class="detail-label">{% trans "Sipariş Tarihi" %}</label>
                                <div class="detail-value" id="detail_siparis_tarihi"></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-item">
                                <label class="detail-label">{% trans "Sevk Tarihi" %}</label>
                                <div class="detail-value" id="detail_sevk_tarihi"></div>
                            </div>
                        </div>
                        <div class="col-12" id="detail_not_container" style="display: none;">
                            <div class="detail-item">
                                <label class="detail-label">{% trans "Notlar" %}</label>
                                <div class="detail-note" id="detail_not"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i>{% trans "Kapat" %}
                    </button>
                    <button type="button" class="btn btn-primary" onclick="printOrderDetails()">
                        <i class="bi bi-printer me-2"></i>{% trans "Yazdır" %}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">{% trans "Siparişi Sil" %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "İptal" %}</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">{% trans "Sil" %}</button>
                </div>
            </div>
        </div>
    </div>

    <link rel="stylesheet" href="{% static 'users/assets/extensions/simple-datatables/style.css' %}">
    <link rel="stylesheet" href="{% static 'users/assets/compiled/css/table-datatable.css' %}">

    <style>
        .bg-gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .detail-item {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            height: 100%;
        }

        .detail-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #6c757d;
            margin-bottom: 0.5rem;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-size: 1rem;
            font-weight: 500;
            color: #212529;
        }

        .detail-note {
            padding: 1rem;
            background: white;
            border-left: 4px solid #0d6efd;
            border-radius: 4px;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        @media print {
            .modal-header,
            .modal-footer {
                display: none !important;
            }

            .modal-dialog {
                max-width: 100% !important;
                margin: 0 !important;
            }

            .modal-content {
                border: none !important;
                box-shadow: none !important;
            }
        }

        .btn-group .btn {
            padding: 0.25rem 0.5rem;
        }
    </style>

    <script>
        let deleteId = null;
        const siparisData = {
            {% for siparis in siparisler %}
                {{ siparis.id }}: {
                    id: {{ siparis.id }},
                    siparis_no: '{{ siparis.siparis_no|escapejs }}',
                    musteri_id: {{ siparis.musteri.id }},
                    musteri_ad: '{{ siparis.musteri.ad|escapejs }}',
                    urun_id: {% if siparis.urun %}{{ siparis.urun.id }}{% else %}null{% endif %},
                    urun_cinsi: '{{ siparis.urun_cinsi|escapejs }}',
                    urun_display: '{{ siparis.get_urun_adi|escapejs }}',
                    miktar: {{ siparis.miktar }},
                    fiyat: {{ siparis.fiyat }},
                    siparis_tarihi: '{{ siparis.siparis_tarihi|date:"Y-m-d" }}',
                    siparis_tarihi_display: '{{ siparis.siparis_tarihi|date:"d.m.Y" }}',
                    uretici: '{{ siparis.uretici|escapejs }}',
                    sevk_tarihi: '{% if siparis.sevk_tarihi %}{{ siparis.sevk_tarihi|date:"Y-m-d" }}{% endif %}',
                    sevk_tarihi_display: '{% if siparis.sevk_tarihi %}{{ siparis.sevk_tarihi|date:"d.m.Y" }}{% else %}-{% endif %}',
                    durum: '{{ siparis.durum }}',
                    not_bilgisi: '{{ siparis.not_bilgisi|escapejs }}'
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
        };

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        document.getElementById('urun').addEventListener('change', function () {
            const selectedOption = this.options[this.selectedIndex];
            const fiyat = selectedOption.getAttribute('data-fiyat');

            if (fiyat && this.value) {
                document.getElementById('fiyat').value = fiyat;
                document.getElementById('urun_cinsi').value = '';
            }
        });

        function openCreateModal() {
            document.getElementById('siparisModalLabel').textContent = '{% trans "Yeni Sipariş" %}';
            document.getElementById('siparisForm').action = '{% url "orders:siparis_olustur" %}';
            document.getElementById('siparis_no').value = '';
            document.getElementById('musteri').value = '';
            document.getElementById('urun').value = '';
            document.getElementById('urun_cinsi').value = '';
            document.getElementById('miktar').value = '';
            document.getElementById('fiyat').value = '';
            document.getElementById('uretici').value = '';
            document.getElementById('siparis_tarihi').value = '';
            document.getElementById('sevk_tarihi').value = '';
            document.getElementById('durum').value = 'onay_bekliyor';
            document.getElementById('not_bilgisi').value = '';
        }

        function openEditModalById(id) {
            const siparis = siparisData[id];
            if (!siparis) {
                console.error('Sipariş bulunamadı:', id);
                return;
            }

            document.getElementById('siparisModalLabel').textContent = '{% trans "Siparişi Düzenle" %}';
            document.getElementById('siparisForm').action = '{% url "orders:siparis_guncelle" 0 %}'.replace('/0/', '/' + id + '/');
            document.getElementById('siparis_no').value = siparis.siparis_no;
            document.getElementById('musteri').value = siparis.musteri_id;
            document.getElementById('urun').value = siparis.urun_id || '';
            document.getElementById('urun_cinsi').value = siparis.urun_cinsi;
            document.getElementById('miktar').value = siparis.miktar;
            document.getElementById('fiyat').value = siparis.fiyat;
            document.getElementById('uretici').value = siparis.uretici;
            document.getElementById('siparis_tarihi').value = siparis.siparis_tarihi;
            document.getElementById('sevk_tarihi').value = siparis.sevk_tarihi;
            document.getElementById('durum').value = siparis.durum;
            document.getElementById('not_bilgisi').value = siparis.not_bilgisi;

            const modal = new bootstrap.Modal(document.getElementById('siparisModal'));
            modal.show();
        }

        function openDetailModalById(id) {
            const siparis = siparisData[id];
            if (!siparis) {
                console.error('Sipariş bulunamadı:', id);
                return;
            }

            document.getElementById('detail_siparis_no').textContent = siparis.siparis_no;
            document.getElementById('detail_musteri').textContent = siparis.musteri_ad;
            document.getElementById('detail_urun_cinsi').textContent = siparis.urun_display;
            document.getElementById('detail_uretici').textContent = siparis.uretici;
            document.getElementById('detail_miktar').textContent = siparis.miktar;
            document.getElementById('detail_fiyat').textContent = '₺' + parseFloat(siparis.fiyat).toFixed(2);
            document.getElementById('detail_toplam').textContent = '₺' + (parseFloat(siparis.miktar) * parseFloat(siparis.fiyat)).toFixed(2);
            document.getElementById('detail_siparis_tarihi').textContent = siparis.siparis_tarihi_display;
            document.getElementById('detail_sevk_tarihi').textContent = siparis.sevk_tarihi_display;

            const durumMap = {
                'hazir': '{% trans "Hazır, Sevkiyat Bekliyor" %}',
                'sevkiyatta': '{% trans "Sevkiyatta" %}',
                'tamamlandi': '{% trans "Tamamlandı" %}',
                'uretiliyor': '{% trans "Üretiliyor" %}',
                'onay_bekliyor': '{% trans "Onay Bekliyor" %}',
                'onaylandi': '{% trans "Onaylandı" %}',
                'malzeme_satin_alma': '{% trans "Malzeme Satın Alma" %}',
                'uretimde': '{% trans "Üretimde" %}',
                'print_tkac': '{% trans "Baskı/Tkacılık" %}',
                'boya': '{% trans "Boya" %}',
                'aksesuar_montaji': '{% trans "Aksesuar Montajı" %}',
                'kalite_kontrol': '{% trans "Kalite Kontrol" %}',
                'paketleme': '{% trans "Paketleme" %}',
                'teslime_gonderildi': '{% trans "Teslime Gönderildi" %}',
                'teslim_edildi': '{% trans "Teslim Edildi" %}',
                'iade_pererabotka': '{% trans "İade/Perak" %}',
                'iptal': '{% trans "İptal" %}'
            };

            const durumColorMap = {
                'hazir': 'success',
                'sevkiyatta': 'primary',
                'tamamlandi': 'secondary',
                'uretiliyor': 'warning',
                'onay_bekliyor': 'info',
                'onaylandi': 'success',
                'malzeme_satin_alma': 'primary',
                'uretimde': 'warning',
                'print_tkac': 'info',
                'boya': 'primary',
                'aksesuar_montaji': 'info',
                'kalite_kontrol': 'warning',
                'paketleme': 'success',
                'teslime_gonderildi': 'primary',
                'teslim_edildi': 'success',
                'iade_pererabotka': 'danger',
                'iptal': 'dark'
            };

            const durumText = durumMap[siparis.durum] || siparis.durum;
            const durumColor = durumColorMap[siparis.durum] || 'secondary';
            document.getElementById('detail_durum').innerHTML = '<span class="badge bg-' + durumColor + '">' + durumText + '</span>';

            const notContainer = document.getElementById('detail_not_container');
            if (siparis.not_bilgisi && siparis.not_bilgisi.trim() !== '') {
                document.getElementById('detail_not').textContent = siparis.not_bilgisi;
                notContainer.style.display = 'block';
            } else {
                notContainer.style.display = 'none';
            }

            const modal = new bootstrap.Modal(document.getElementById('detailModal'));
            modal.show();
        }

        function printOrderDetails() {
            window.print();
        }

        function openDeleteModal(id, siparisNo) {
            deleteId = id;
            document.getElementById('deleteMessage').textContent = '{% trans "Siparişi silmek istediğinizden emin misiniz?" %} (' + siparisNo + ')';

            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
        }

        function confirmDelete() {
            if (!deleteId) return;

            const csrftoken = getCookie('csrftoken');
            const currentPath = window.location.pathname;
            const langPrefix = currentPath.split('/')[1];
            const url = '/' + langPrefix + '/orders/siparis/' + deleteId + '/sil/';

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error! status: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                        modal.hide();

                        const tableRow = document.querySelector(`button[onclick*="openDeleteModal(${deleteId}"]`).closest('tr');
                        if (tableRow) {
                            tableRow.remove();
                        }

                        delete siparisData[deleteId];
                        deleteId = null;

                        const successAlert = document.createElement('div');
                        successAlert.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
                        successAlert.style.zIndex = '9999';
                        successAlert.innerHTML = `
                            <i class="bi bi-check-circle me-2"></i>
                            Sipariş başarıyla silindi!
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        document.body.appendChild(successAlert);

                        setTimeout(() => {
                            successAlert.remove();
                        }, 3000);
                    } else {
                        alert('Sipariş silinirken bir hata oluştu: ' + (data.error || 'Bilinmeyen hata'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Bir hata oluştu: ' + error.message);
                });
        }

        document.getElementById('siparisForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const csrftoken = getCookie('csrftoken');

            fetch(this.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('siparisModal'));
                        modal.hide();
                        location.reload();
                    } else {
                        let errorMsg = 'Bir hata oluştu:\n';
                        for (let field in data.errors) {
                            errorMsg += field + ': ' + data.errors[field].join(', ') + '\n';
                        }
                        alert(errorMsg);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Bir hata oluştu!');
                });
        });
    </script>

    <script src="{% static 'users/assets/extensions/simple-datatables/umd/simple-datatables.js' %}"></script>
    <script src="{% static 'users/assets/static/js/pages/simple-datatables.js' %}"></script>
{% endblock %}